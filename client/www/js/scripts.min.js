
(function() {
  'use strict'

  var dependencies = [
    'ui.router',
    'googlechart',
    'ngAnimate',
    'ngMessages',
    'angularMoment'
  ]

  angular.module('panic', dependencies)
  .constant({'API_URL': resolveApiUrl() + '/api/v1'})
   .run(routeEvent)

   resolveApiUrl.$inject = ['$http']

   function resolveApiUrl($http){
     if(window.location.origin === "http://localhost:5000") return 'http://localhost:3000';
     return 'https://panic-button-g20.herokuapp.com'
   }

   routeEvent.$inject = ['$rootScope', '$state', '$window'];

   function routeEvent($rootScope, $state, $window){
     $rootScope.$on('$stateChangeStart', function(event, state){
       if(!$window.localStorage.getItem('token') && state.loggedInOnly){
         event.preventDefault();
         $state.go('landing');
       }
       if($window.localStorage.getItem('token') && state.loggedOutOnly){
         event.preventDefault();
         $state.go('dashboard');
       }
     })
   }
})();

(function() {
  'use strict';

  angular.module('panic')
  .factory('authService', authFactory);

 authFactory.$inject = [
    '$log',
     '$http',
     '$state',
     '$window',
     'API_URL'
  ];

  function authFactory ($log, $http, $state, $window, API_URL) {
    var AUTH_ENDPOINTS = $http.get(API_URL).then(function (res){
      return $http.get(res.data.auth)
    })

    var authFactory = {
      session: {currentUser: null},
      login: login,
      signup: signup,
      me: me
    }

    return authFactory

    function login (user) {
      return AUTH_ENDPOINTS.then(function(AUTH_ENDPOINTS){
        AUTH_ENDPOINTS = AUTH_ENDPOINTS.data;
        return $http.post(AUTH_ENDPOINTS.login, user).then(function (res){
          $window.localStorage.setItem('token', res.data.token)
          return res.data
        })
      })
    }

    function signup (user) {
      return AUTH_ENDPOINTS.then(function(AUTH_ENDPOINTS){
        AUTH_ENDPOINTS = AUTH_ENDPOINTS.data;
        return $http.post(AUTH_ENDPOINTS.signup, user).then(function (res){
          $window.localStorage.setItem('token', res.data.token)
          return res.data
        })
      })
    }

    function me(){
      return AUTH_ENDPOINTS.then(function(AUTH_ENDPOINTS){
        AUTH_ENDPOINTS = AUTH_ENDPOINTS.data;
        return $http.get(AUTH_ENDPOINTS.me).then(function(res){
          authFactory.session.currentUser = Object.keys(res.data).length > 0 ? res.data : null;
          return Promise.resolve(authFactory.session);
        }).catch(function (err){
          return Promise.reject(err);
        });
      });
    }
  }
}());

(function() {
  'use strict';

  angular.module('panic')
  .factory('dashboardService', dashboardFactory);

 dashboardFactory.$inject = [
    '$log',
     '$http',
     '$state',
     '$window',
     'API_URL'
  ];

  function dashboardFactory ($log, $http, $state, $window, API_URL) {
    var AUTH_ENDPOINTS = $http.get(API_URL).then(function (res){
      return $http.get(res.data.participations)
    })

    var dashboardFactory = {
      getClass: getClass,
      getClassInfo: getClassInfo,
    }

    return dashboardFactory

    function getClass(){
      return AUTH_ENDPOINTS.then(function(res){
        return res.data
        }).catch(function (err){
          return err;
        })
      }

    function getClassInfo (url) {
      return $http.get(url).then(function (res) {
        return res.data
      })
    }


  }
}());

(function() {
  'use strict'

  angular.module('panic')
  .config(setupRoutes)

  setupRoutes.$inject = [
    '$stateProvider',
    '$urlRouterProvider',
    '$locationProvider',
    '$httpProvider',
  ];

  function setupRoutes($stateProvider, $urlRouterProvider, $locationProvider, $httpProvider) {
    $httpProvider.interceptors.push("AuthInterceptorService");
    $locationProvider.html5Mode(true);
    $urlRouterProvider.otherwise("/");
    $stateProvider
      .state('landing', {
        url: '/',
        template: "<landing-directive></landing-directive>",
        loggedOutOnly: true
      })
      .state('student', {
        url: '/lecture/:id',
        template: "<lecture-student></lecture-student>",
        resolve: {
          user: getMe
        }
      })
      .state('teacher', {
        url: '/teacher/:id',
        template: "<lecture-teacher></lecture-teacher>",
        // loggedInOnly: true
      })
      .state('dashboard', {
        url: '/dashboard',
        template: "<dashboard></dashboard>",
        loggedInOnly: true,
        resolve: {
          user: getMe
        }
      })
      .state('classInfo', {
        url: '/:classId',
        templateUrl: "partials/dashboard.info.html",
        loggedInOnly: true,
        parent: 'dashboard',
        resolve: {
          user: getMe
        }
      })
      // .state('dashboard.teaching', {
      //   url: '/teaching',
      //   templateUrl: "partials/dashboard.teaching.html",
      //   loggedInOnly: true,
      //   parent: 'dashboard',
      //   resolve: {
      //     user: getMe
      //   }
      // })

      // .state('dashboard.attending', {
      //   url: '/attending',
      //   templateUrl: "partials/dashboard.attending.html",
      //   loggedInOnly: true,
      //   parent: 'dashboard',
      //   resolve: {
      //     user: getMe
      //   }
      // })

  }

  getMe.$inject = ['authService'];
  function getMe(authService) {
    return authService.me();
  }

})();

(function() {
  'use strict';

    angular.module('panic')
      .directive('landingDirective', landingDirective);

      function landingDirective (){
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/landing.html",
          controller: landingController,
          controllerAs: "vm"
        }
      }

      landingController.$inject = [
        '$scope',
        '$log',
        '$state',
        'authService'
      ];

      function landingController($scope, $log, $state, authService) {
        var vm = this;
        vm.classCodeSubmit = classCodeSubmit;
        vm.loginSubmit = loginSubmit;
        vm.signupSubmit = signupSubmit;

        function classCodeSubmit () {
          console.log('class code', vm.classCode);
          vm.frm = {}
          $state.go('student');
        }

        function loginSubmit () {
          var user = angular.copy(vm.login)
          authService.login(user).then(function (res){
            $state.go('dashboard');
          })
        }

        function signupSubmit (){
          var user = angular.copy(vm.signup);
          authService.signup(user).then(function (res){
            $state.go('dashboard');
          })
        }

      }

}());

(function() {
  'use strict';

    angular.module('panic')
      .directive('dashboard', dashboardDirective);

      function dashboardDirective (){
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/dashboard.html",
          controller: dashboardController,
          controllerAs: "vm"
        }
      }

      dashboardController.$inject = [
        '$log',
        '$state',
        'dashboardService',
        'authService'
      ];

      function dashboardController($log, $state, dashboardService, authService) {
        var vm = this;
        vm.info = {};
        vm.session = authService.session;
        vm.getInfo = getInfo;

        dashboardService.getClass()
        .then(function (res){
          vm.teaching = [];
          vm.attending = [];
          for (var i = 0; i < res.length; i++) {
            if(res[i].attributes.instructor){
              vm.teaching.push(res[i]);
            } else {
              vm.attending.push(res[i]);
            }
          }
          return res
        }).then(function (res){
          for (var i = 0; i < res.length; i++) {
            if(+res[i].attributes.id === +$state.params.classId) {
              return getInfo(res[i].links.summary)
            }
          }
        })

        function getInfo (url){
          return dashboardService.getClassInfo(url)
          .then(function(res) {
            vm.info.lectures = res.lectures;
            vm.info.participants = res.participants;
            return
          })
        }

      }

}());

(function() {
  'use strict';
    angular.module('panic')
      .directive('lectureStudent', lectureDirective);

      function lectureDirective (){
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/lecture.student.html",
          controller: lectureController,
          controllerAs: "vm"
        }
      }

      lectureController.$inject = [
        '$log',
        '$state',
        'authService'
      ];

      function lectureController($log, $state, authService) {
        var socket = io.connect('http://localhost:3000/');
        var vm = this;
        var lectureId = $state.params.id
        vm.session = authService.session;
        this.vote = vote;

        function vote (status) {
          console.log('vote!');
          socket.emit('chart', {lectureId: lectureId, user_id: 1, status: status} )
        }

      }

}());

(function() {
  'use strict';

    angular.module('panic')
      .directive('lectureTeacher', lectureTeacherDirective);

      function lectureTeacherDirective () {
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/lecture.teacher.html",
          controller: lectureTeacherController,
          controllerAs: "vm"
        }
      }

      lectureTeacherController.$inject = [
        '$log',
        '$state'
      ];

      function lectureTeacherController($log, $state) {
        var vm = this;

      }

}());

(function() {
  'use strict';

  angular.module('panic')
  .factory('AuthInterceptorService', factory)

    factory.$inject = ['$window', '$injector'];

    function factory($window, $injector) {
    return {
     'request': function(req) {
      //  console.log('sending token');
        var token = localStorage.getItem('token');
        if (token) req.headers.authentication = token;
        return req;
      },

      'responseError': function(response) {
        // console.log(response);
        if(response.status === 401) {
          $window.localStorage.clear();
          $injector.get('$state').go('landing');
        }
        return response;
        }
      };
    }

}());

(function() {
  'use strict';

  angular.module('panic')
  .directive('areaChart', directive)

  function directive () {
    return {
      scope: {},
      template: '<div google-chart chart="areaChart"></div>',
      controller: controller,
    }

    function controller ($scope, $rootScope, ChartFactory) {
      var i = 0;
      var lectureId = ChartFactory.lectureId
      $scope.className = 'class'

      $rootScope.$on(lectureId, function (event, data) {
        console.log('area', data);
        for (var i = 0; i < data.length; i++) {
          var roster = data[i].roster
          var time = data[i].time
          var students = roster.length;
          var g = 0 ;
          var u = 0 ;
          var d = 0 ;
          for (var i = 0; i < roster.length; i++) {
            switch (roster[i].status_id) {
              case 1:
                g++
                break;
              case 2:
                u++
                break;
              case 3:
                d++;
                break;
            }
          }
          d = d/students * 100;
          u = u/students * 100;
          g = g/students * 100;

          areaChart.data.rows.push({c: [{v: time }, {v: d}, {v: u}, {v: g}] })
        }
      })

      var areaChart = {};
      areaChart.type = "AreaChart";
      areaChart.displayed = false;
      areaChart.data = {};
      areaChart.data.rows = []

      areaChart.data.rows.push({c: [{v: "Lecture start"},{v: 0},{v: 100},{v: 0} ] })

      areaChart.data.cols = [
          {id: "month",label: "Month",type: "string"},
          {id: "DaFuq",label: "I don't get it",type: "number"},
          {id: "NoVote",label: "Undecided",type: "number"},
          {id: "GotIt",label: "I got it",type: "number"},
        ];
      areaChart.options = {
        "title": $scope.className,
        "isStacked": "true",
        "fill": 20,
        "displayExactValues": true,
        "vAxis": {
          "title": "Percent class",
          "gridlines": {
            "count": 5
          }
        },
        "hAxis": {
          "title": "Time",
          "scaleType": 'log'

        }
      };
      $scope.areaChart = areaChart;

    }
  }


}());

(function() {
  'use strict';

  angular.module('panic')
  .factory('ChartFactory', factory)

  // factory.$inject = [ '$rootScope', '$location']

  function factory ($rootScope, $location, $state, $http, API_URL) {
    $rootScope.$on( "$stateChangeSuccess", function(event, next, current) {
      console.log('chart.factory', $route.current.params);
    })

    var service = {
      lectureId: $state.params.id,
      graphData: graphData,
    }
    return service

    function graphData () {
      return $http.get(API_URL + '/lectures/'+service.lectureId+'/understandings')
      .then( function (res) {
        console.log(res);
      })
    }
  }


}());

(function() {
  'use strict';

  angular.module('panic')
  .directive('pieChart', directive)

  function directive () {
    return {
      scope: {},
      template: '<button ng-click="sock()">sock</button><div google-chart chart="pieChart" id="pieChart"></div>',
      controller: controller,
    }
    function controller ($scope, $rootScope, $state, ChartFactory) {
      var socket = io.connect('http://localhost:3000/');
      var pieChart = {};
      var lectureId = $state.params.id;
      ChartFactory.graphData();
      socket.emit('set', lectureId)

      // $scope.sock = function () {
      //   socket.emit('chart', lectureId)
      // }

      // socket.on(lectureId, function (data) {
      //   if (!(data === null)) {
      //     var roster = data[data.length-1].roster
      //     var students = roster.length;
      //     var g = 0 ;
      //     var u = 0 ;
      //     var d = 0 ;
      //     for (var i = 0; i < roster.length; i++) {
      //       switch (roster[i].status_id) {
      //         case 1:
      //           g++
      //           break;
      //         case 2:
      //           u++
      //           break;
      //         case 3:
      //           d++;
      //           break;
      //       }
      //     }
      //       $scope.vote[0]= { 'c': [ { 'v': 'I dont get it' }, {'v' : d} ] }
      //       $scope.vote[1] = { 'c': [ { 'v': 'undecided'}, {'v' : u} ] }
      //       $scope.vote[2] = { 'c': [ { 'v':  'I get it'}, {'v' : g } ] }
      //     $rootScope.$emit(lectureId, data)
      //     $scope.$apply()
      //   }
      // })

      $scope.$on('$destroy', function (event) {
        socket.removeAllListeners();
      });

      pieChart.type = 'PieChart';
      pieChart.displayed = false;
      pieChart.data = {}
      $scope.vote = [];
      $scope.vote[0]= { 'c': [ { 'v': 'dafuq' }, {'v' : 0} ] }
      $scope.vote[1] = { 'c': [ { 'v': 'novote'}, {'v' : 100} ] }
      $scope.vote[2] = { 'c': [ { 'v':  'gotit'}, {'v' : 0 } ] }
      pieChart.data.rows = $scope.vote

      pieChart.data.cols = [
        { "id": "month", "label": "Month", "type": "string" },
        { "id": "laptop-id", "label": "Laptop", "type": "number" },
        { "id": "desktop-id", "label": "Desktop", "type": "number" },
        { "id": "server-id", "label": "Server", "type": "number" },
        { "id": "cost-id", "label": "Shipping", "type": "number" }
      ];

        pieChart.formatters = {}
        pieChart.options = {
          "isStacked": "true",
          "fill": 20,
          "displayExactValues": true,
          },



        $scope.pieChart = pieChart;
    }
  }


}());
